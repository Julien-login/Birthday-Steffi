<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geburtstags-Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: #0c001f; color: #ffffff; overflow-x: hidden; }
        #fireworks-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        #countdown-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding: 20px; }
        .countdown-tile { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 15px; padding: 20px; text-align: center; backdrop-filter: blur(10px); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .countdown-tile:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .tile-name { font-size: 1.8rem; font-weight: 700; margin-bottom: 15px; }
        .tile-time { display: flex; justify-content: space-around; margin-bottom: 15px; }
        .tile-time .time-box { font-size: 1.5rem; font-weight: 500; }
        .tile-time .time-box span { display: block; font-size: 0.7rem; font-weight: 300; }
        .tile-birthday-text { display: none; font-size: 1.2rem; font-weight: 500; margin-top: 15px; }
        .countdown-tile.is-birthday { background: linear-gradient(45deg, #ff0077, #ff9100); transform: scale(1.05); box-shadow: 0 0 30px #ff0077; }
        .countdown-tile.is-birthday .tile-time { display: none; }
        .countdown-tile.is-birthday .tile-birthday-text { display: block; }
        .countdown-tile.is-birthday .tile-name::after { content: ' ü•≥'; }
        
        /* NEU: Knopf zum √ñffnen der Datenverwaltung */
        #manage-data-button { position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; background-color: #8a2be2; color: white; border: none; border-radius: 25px; font-size: 1rem; font-weight: 500; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: transform 0.2s ease; z-index: 1001; }
        #manage-data-button:hover { transform: scale(1.05); }

        /* NEU: Container f√ºr die Tabellenansicht */
        #data-table-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .table-view-content { background: #1a043a; padding: 20px; border-radius: 15px; width: 95%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; }
        .table-view-content h2 { text-align: center; margin-bottom: 15px; }
        .table-wrapper { overflow-y: auto; }
        #data-table { width: 100%; border-collapse: collapse; }
        #data-table th, #data-table td { padding: 12px; border: 1px solid #4a2d6b; text-align: left; }
        #data-table th { background-color: #2a104f; }
        #data-table td[contenteditable="true"] { background-color: rgba(255,255,255,0.1); cursor: text; }
        .table-controls { margin-top: 20px; display: flex; justify-content: space-between; }
        .table-controls button { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; }
        #add-row-btn { background-color: #3b8d3b; color: white; }
        .delete-row-btn { background-color: #c00; color: white; border: none; padding: 5px 8px; border-radius: 50%; cursor: pointer; }
        #save-table-btn { background-color: #8a2be2; color: white; }
    </style>
</head>
<body>
    <canvas id="fireworks-canvas"></canvas>
    <main id="countdown-grid"></main>
    <button id="manage-data-button">Daten verwalten</button>
    
    <div id="data-table-container">
        <div class="table-view-content">
            <h2>Geburtstage verwalten</h2>
            <div class="table-wrapper">
                <table id="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Datum (TT.MM.JJJJ oder JJJJ-MM-TT)</th>
                            <th>Nachricht</th>
                            <th>L√∂schen</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body">
                        </tbody>
                </table>
            </div>
            <div class="table-controls">
                <button id="add-row-btn">+ Zeile hinzuf√ºgen</button>
                <button id="save-table-btn">Speichern & Schlie√üen</button>
            </div>
        </div>
    </div>

    <template id="countdown-tile-template">
        <div class="countdown-tile"><h3 class="tile-name"></h3><div class="tile-time"><div class="time-box"><span class="days">0</span><span>Tage</span></div><div class="time-box"><span class="hours">0</span><span>Stunden</span></div><div class="time-box"><span class="minutes">0</span><span>Minuten</span></div><div class="time-box"><span class="seconds">0</span><span>Sekunden</span></div></div><p class="tile-birthday-text"></p></div>
    </template>
    
    <script>
        const fireworksCanvas = document.getElementById('fireworks-canvas'); const fireworksCtx = fireworksCanvas.getContext('2d'); fireworksCanvas.width = window.innerWidth; fireworksCanvas.height = window.innerHeight; let fireworks = []; let particles = []; let fireworksIntensity = 1500; function Particle(x,y,c,v){this.x=x;this.y=y;this.color=c;this.velocity=v;this.alpha=1;this.life=Math.random()*30+60;this.update=()=>{this.x+=this.velocity.x;this.y+=this.velocity.y;this.velocity.y+=.02;this.alpha-=.015;this.life--};this.draw=()=>{fireworksCtx.save();fireworksCtx.globalAlpha=this.alpha;fireworksCtx.beginPath();fireworksCtx.arc(this.x,this.y,2,0,2*Math.PI,!1);fireworksCtx.fillStyle=this.color;fireworksCtx.fill();fireworksCtx.restore()}}
        function Firework(x,y,tx,ty){this.x=x;this.y=y;this.targetX=tx;this.targetY=ty;const a=Math.atan2(ty-y,tx-x),s=10;this.velocity={x:Math.cos(a)*s,y:Math.sin(a)*s};this.color=`hsl(${360*Math.random()}, 100%, 50%)`;this.update=()=>{const d=Math.hypot(this.targetX-this.x,this.targetY-this.y);if(d<s){for(let i=0;i<50;i++){const a=2*Math.PI*Math.random(),s=5*Math.random();particles.push(new Particle(this.x,this.y,this.color,{x:Math.cos(a)*s,y:Math.sin(a)*s}))}return!0}this.x+=this.velocity.x;this.y+=this.velocity.y;this.velocity.y*=.99;return!1};this.draw=()=>{fireworksCtx.beginPath();fireworksCtx.arc(this.x,this.y,3,0,2*Math.PI,!1);fireworksCtx.fillStyle=this.color;fireworksCtx.fill()}}
        function launchFirework(){const sx=fireworksCanvas.width/2,sy=fireworksCanvas.height,tx=Math.random()*fireworksCanvas.width,ty=Math.random()*fireworksCanvas.height/2;fireworks.push(new Firework(sx,sy,tx,ty))}
        let launchInterval;function setFireworksInterval(){clearInterval(launchInterval);launchInterval=setInterval(launchFirework,fireworksIntensity)}
        function animateFireworks(){requestAnimationFrame(animateFireworks);fireworksCtx.fillStyle="rgba(12, 0, 31, 0.15)";fireworksCtx.fillRect(0,0,fireworksCanvas.width,fireworksCanvas.height);fireworks.forEach((f,i)=>{f.update()?fireworks.splice(i,1):f.draw()});particles.forEach((p,i)=>{p.alpha<=0||p.life<=0?particles.splice(i,1):(p.update(),p.draw())})}
        window.addEventListener("resize",()=>{fireworksCanvas.width=window.innerWidth;fireworksCanvas.height=window.innerHeight});animateFireworks();setFireworksInterval();

        document.addEventListener('DOMContentLoaded', () => {
            // DOM-Elemente holen
            const grid = document.getElementById('countdown-grid');
            const tileTemplate = document.getElementById('countdown-tile-template');
            const manageDataButton = document.getElementById('manage-data-button');
            const dataTableContainer = document.getElementById('data-table-container');
            const dataTableBody = document.getElementById('data-table-body');
            const addRowBtn = document.getElementById('add-row-btn');
            const saveTableBtn = document.getElementById('save-table-btn');

            let countdownData = [];
            const loadData = () => { const data = localStorage.getItem('countdownDashboard'); let rawData = data ? JSON.parse(data) : []; countdownData = rawData.map(item => { if (item.birthDate && !item.date) { item.date = item.birthDate; delete item.birthDate; } return item; }); };
            const saveData = () => { localStorage.setItem('countdownDashboard', JSON.stringify(countdownData)); };
            const getNextBirthdayInfo = (dateString) => { if (!dateString) return { timestamp: NaN }; const date = new Date(dateString); const today = new Date(); today.setHours(0, 0, 0, 0); const currentYear = today.getFullYear(); let nextBirthday = new Date(currentYear, date.getMonth(), date.getDate()); if (nextBirthday < today) { nextBirthday.setFullYear(currentYear + 1); } return { timestamp: nextBirthday.getTime() }; };
            
            // --- DATEN-TABELLEN-LOGIK ---
            const parseDateString = (dateStr) => {
                if (!dateStr) return null;
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return new Date(dateStr);
                const parts = dateStr.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
                if (parts) return new Date(parts[3], parts[2] - 1, parts[1]);
                const jsDate = new Date(dateStr);
                return isNaN(jsDate) ? null : jsDate;
            };

            const openTableView = () => {
                dataTableBody.innerHTML = ''; // Leere alte Zeilen
                countdownData.forEach(item => {
                    const row = dataTableBody.insertRow();
                    row.innerHTML = `
                        <td contenteditable="true">${item.name}</td>
                        <td contenteditable="true">${item.date}</td>
                        <td contenteditable="true">${item.message}</td>
                        <td><button class="delete-row-btn">X</button></td>
                    `;
                });
                dataTableContainer.style.display = 'flex';
            };

            const handleSaveTable = () => {
                const newCountdownData = [];
                const rows = dataTableBody.querySelectorAll('tr');
                let failedRows = 0;
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const name = cells[0].textContent.trim();
                    const dateStr = cells[1].textContent.trim();
                    const message = cells[2].textContent.trim();

                    const parsedDate = parseDateString(dateStr);
                    if (name && parsedDate) {
                        const isoDate = parsedDate.toISOString().split('T')[0];
                        newCountdownData.push({ id: Date.now() + Math.random(), name, date: isoDate, message: message || `Happy Birthday, ${name}!` });
                    } else {
                        failedRows++;
                    }
                });

                if (failedRows > 0) {
                    alert(`${failedRows} Zeile(n) konnte(n) nicht gespeichert werden, da der Name fehlte oder das Datumsformat ung√ºltig war.`);
                }
                countdownData = newCountdownData;
                saveData();
                renderAllTiles();
                dataTableContainer.style.display = 'none';
            };

            const handleAddRow = () => {
                const row = dataTableBody.insertRow();
                row.innerHTML = `
                    <td contenteditable="true"></td>
                    <td contenteditable="true"></td>
                    <td contenteditable="true"></td>
                    <td><button class="delete-row-btn">X</button></td>
                `;
            };

            const renderAllTiles = () => {
                countdownData.forEach(item => item.nextBirthdayInfo = getNextBirthdayInfo(item.date));
                countdownData.sort((a, b) => a.nextBirthdayInfo.timestamp - b.nextBirthdayInfo.timestamp);
                grid.innerHTML = '';
                countdownData.forEach(item => {
                    const tileClone = tileTemplate.content.cloneNode(true);
                    const tileElement = tileClone.querySelector('.countdown-tile');
                    tileElement.dataset.id = item.id;
                    tileElement.querySelector('.tile-name').textContent = item.name;
                    tileElement.querySelector('.tile-birthday-text').textContent = item.message;
                    grid.appendChild(tileElement);
                });
                updateAllTimers();
            };

            const updateAllTimers = () => {
                let birthdayIsHappening = false;
                document.querySelectorAll('.countdown-tile').forEach(tile => {
                    const id = parseFloat(tile.dataset.id); // parseFloat to handle potential random number
                    const item = countdownData.find(d => d.id === id);
                    if (!item || !item.nextBirthdayInfo) return;
                    const now = new Date().getTime(); const distance = item.nextBirthdayInfo.timestamp - now;
                    if (isNaN(distance)) return;
                    const oneDayInMs = 864e5;
                    if (distance < -oneDayInMs) { renderAllTiles(); return; }
                    if (distance < 0) { tile.classList.add('is-birthday'); birthdayIsHappening = true; } else {
                        tile.classList.remove('is-birthday');
                        const days = Math.floor(distance / oneDayInMs); const hours = Math.floor((distance % oneDayInMs) / 36e5); const minutes = Math.floor((distance % 36e5) / 6e4); const seconds = Math.floor((distance % 6e4) / 1e3);
                        tile.querySelector('.days').textContent = days; tile.querySelector('.hours').textContent = hours; tile.querySelector('.minutes').textContent = minutes; tile.querySelector('.seconds').textContent = seconds;
                    }
                });
                const newIntensity = birthdayIsHappening ? 400 : 1500;
                if (newIntensity !== fireworksIntensity) { fireworksIntensity = newIntensity; setFireworksInterval(); }
            };
            
            // --- EVENT LISTENERS ---
            manageDataButton.addEventListener('click', openTableView);
            saveTableBtn.addEventListener('click', handleSaveTable);
            addRowBtn.addEventListener('click', handleAddRow);
            // Delegierter Event Listener f√ºr die L√∂schen-Kn√∂pfe
            dataTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-row-btn')) {
                    e.target.closest('tr').remove();
                }
            });
            
            // Initialisierung
            loadData();
            renderAllTiles();
            setInterval(updateAllTimers, 1000);
        });
    </script>
</body>
</html>
