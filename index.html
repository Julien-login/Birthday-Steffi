<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geburtstags-Dashboard</title>
    <style>
        /* CSS ist unver√§ndert */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: #0c001f; color: #ffffff; overflow-x: hidden; }
        #fireworks-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        #countdown-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding: 20px; }
        .countdown-tile { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 15px; padding: 20px; text-align: center; backdrop-filter: blur(10px); transition: transform 0.3s ease, box-shadow 0.3s ease; cursor: pointer; }
        .countdown-tile:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .tile-name { font-size: 1.8rem; font-weight: 700; margin-bottom: 15px; }
        .tile-time { display: flex; justify-content: space-around; margin-bottom: 15px; }
        .tile-time .time-box { font-size: 1.5rem; font-weight: 500; }
        .tile-time .time-box span { display: block; font-size: 0.7rem; font-weight: 300; }
        .tile-birthday-text { display: none; font-size: 1.2rem; font-weight: 500; margin-top: 15px; }
        .countdown-tile.is-birthday { background: linear-gradient(45deg, #ff0077, #ff9100); transform: scale(1.05); box-shadow: 0 0 30px #ff0077; }
        .countdown-tile.is-birthday .tile-time { display: none; }
        .countdown-tile.is-birthday .tile-birthday-text { display: block; }
        .countdown-tile.is-birthday .tile-name::after { content: ' ü•≥'; }
        #add-new-button { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background-color: #8a2be2; color: white; border: none; border-radius: 50%; font-size: 2.5rem; line-height: 60px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: transform 0.2s ease; z-index: 1001; }
        #add-new-button:hover { transform: scale(1.1); }
        #add-form-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
        #add-form { background: #1a043a; padding: 30px; border-radius: 15px; display: flex; flex-direction: column; gap: 15px; width: 90%; max-width: 400px; }
        #add-form h2 { margin-bottom: 10px; }
        #add-form label { font-size: 0.9rem; opacity: 0.8; }
        #add-form input { width: 100%; padding: 12px; border: 1px solid #8a2be2; background: rgba(0,0,0,0.2); color: white; border-radius: 8px; font-family: inherit; }
        #add-form .form-buttons { display: flex; gap: 10px; margin-top: 10px; }
        #add-form button { flex-grow: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; transition: background-color 0.2s; }
        #add-form button[type="submit"] { background-color: #8a2be2; color: white; }
        #add-form button[type="button"] { background-color: #444; color: white; }
        #add-form button.delete-button { background-color: #c00; color: white; display: none; }
        #add-form button:hover { opacity: 0.9; }
    </style>
</head>
<body>
    <canvas id="fireworks-canvas"></canvas>
    <main id="countdown-grid"></main>
    <button id="add-new-button">+</button>
    <div id="add-form-container">
        <form id="add-form">
            <h2 id="form-title">Neuen Countdown hinzuf√ºgen</h2>
            <input type="text" id="form-name" placeholder="Name" required>
            <label for="form-date">Geburtstag (Tag & Monat)</label>
            <input type="date" id="form-date" required>
            <input type="text" id="form-message" placeholder="Text am Geburtstag" required>
            <div class="form-buttons">
                <button type="submit" id="form-submit-button">Hinzuf√ºgen</button>
                <button type="button" id="form-delete" class="delete-button">L√∂schen</button>
            </div>
            <button type="button" id="form-cancel">Abbrechen</button>
        </form>
    </div>
    <template id="countdown-tile-template">
        <div class="countdown-tile">
            <h3 class="tile-name"></h3>
            <div class="tile-time">
                <div class="time-box"><span class="days">0</span><span>Tage</span></div>
                <div class="time-box"><span class="hours">0</span><span>Stunden</span></div>
                <div class="time-box"><span class="minutes">0</span><span>Minuten</span></div>
                <div class="time-box"><span class="seconds">0</span><span>Sekunden</span></div>
            </div>
            <p class="tile-birthday-text"></p>
        </div>
    </template>
    <script>
        const fireworksCanvas = document.getElementById('fireworks-canvas');
        const fireworksCtx = fireworksCanvas.getContext('2d');
        fireworksCanvas.width = window.innerWidth;
        fireworksCanvas.height = window.innerHeight;
        let fireworks = [];
        let particles = [];
        let fireworksIntensity = 1500;
        function Particle(x, y, color, velocity) { this.x = x; this.y = y; this.color = color; this.velocity = velocity; this.alpha = 1; this.life = Math.random() * 30 + 60; this.update = () => { this.x += this.velocity.x; this.y += this.velocity.y; this.velocity.y += 0.02; this.alpha -= 0.015; this.life--; }; this.draw = () => { fireworksCtx.save(); fireworksCtx.globalAlpha = this.alpha; fireworksCtx.beginPath(); fireworksCtx.arc(this.x, this.y, 2, 0, Math.PI * 2, false); fireworksCtx.fillStyle = this.color; fireworksCtx.fill(); fireworksCtx.restore(); }; }
        function Firework(x, y, targetX, targetY) { this.x = x; this.y = y; this.targetX = targetX; this.targetY = targetY; const angle = Math.atan2(targetY - y, targetX - x); const speed = 10; this.velocity = { x: Math.cos(angle) * speed, y: Math.sin(angle) * speed }; this.color = `hsl(${Math.random() * 360}, 100%, 50%)`; this.update = () => { const distance = Math.hypot(this.targetX - this.x, this.targetY - this.y); if (distance < speed) { for (let i = 0; i < 50; i++) { const angle = Math.random() * Math.PI * 2; const speed = Math.random() * 5; particles.push(new Particle(this.x, this.y, this.color, { x: Math.cos(angle) * speed, y: Math.sin(angle) * speed })); } return true; } else { this.x += this.velocity.x; this.y += this.velocity.y; this.velocity.y *= 0.99; } return false; }; this.draw = () => { fireworksCtx.beginPath(); fireworksCtx.arc(this.x, this.y, 3, 0, Math.PI * 2, false); fireworksCtx.fillStyle = this.color; fireworksCtx.fill(); }; }
        function launchFirework() { const startX = fireworksCanvas.width / 2; const startY = fireworksCanvas.height; const targetX = Math.random() * fireworksCanvas.width; const targetY = Math.random() * fireworksCanvas.height / 2; fireworks.push(new Firework(startX, startY, targetX, targetY)); }
        let launchInterval; function setFireworksInterval() { if (launchInterval) clearInterval(launchInterval); launchInterval = setInterval(launchFirework, fireworksIntensity); }
        function animateFireworks() { requestAnimationFrame(animateFireworks); fireworksCtx.fillStyle = 'rgba(12, 0, 31, 0.15)'; fireworksCtx.fillRect(0, 0, fireworksCanvas.width, fireworksCanvas.height); fireworks.forEach((f, i) => { if (f.update()) fireworks.splice(i, 1); else f.draw(); }); particles.forEach((p, i) => { if (p.alpha <= 0 || p.life <= 0) particles.splice(i, 1); else { p.update(); p.draw(); } }); }
        window.addEventListener('resize', () => { fireworksCanvas.width = window.innerWidth; fireworksCanvas.height = window.innerHeight; });
        animateFireworks(); setFireworksInterval();

        document.addEventListener('DOMContentLoaded', () => {
            const grid = document.getElementById('countdown-grid');
            const tileTemplate = document.getElementById('countdown-tile-template');
            const addButton = document.getElementById('add-new-button');
            const formContainer = document.getElementById('add-form-container');
            const form = document.getElementById('add-form');
            const formCancelButton = document.getElementById('form-cancel');
            const formTitle = document.getElementById('form-title');
            const formSubmitButton = document.getElementById('form-submit-button');
            const formDeleteButton = document.getElementById('form-delete');
            let countdownData = [];
            let editingTileId = null;

            const loadData = () => {
                const data = localStorage.getItem('countdownDashboard');
                let rawData = data ? JSON.parse(data) : [];
                countdownData = rawData.map(item => {
                    if (item.birthDate && !item.date) { item.date = item.birthDate; delete item.birthDate; }
                    return item;
                });
            };
            const saveData = () => { localStorage.setItem('countdownDashboard', JSON.stringify(countdownData)); };
            const openAddForm = () => { editingTileId = null; form.reset(); formTitle.textContent = 'Neuen Countdown hinzuf√ºgen'; formSubmitButton.textContent = 'Hinzuf√ºgen'; formDeleteButton.style.display = 'none'; formContainer.style.display = 'flex'; };
            const openEditForm = (id) => { const item = countdownData.find(d => d.id === id); if (!item) return; editingTileId = id; form.reset(); formTitle.textContent = 'Countdown bearbeiten'; formSubmitButton.textContent = 'Speichern'; document.getElementById('form-name').value = item.name; document.getElementById('form-date').value = item.date; document.getElementById('form-message').value = item.message; formDeleteButton.style.display = 'block'; formContainer.style.display = 'flex'; };
            const closeForm = () => { formContainer.style.display = 'none'; };

            const getNextBirthdayInfo = (dateString) => {
                if (!dateString) return { timestamp: NaN };
                const date = new Date(dateString);
                const today = new Date();
                // ***** HIER IST DIE KORREKTUR *****
                // Setzt die Uhrzeit von "heute" auf Mitternacht, um nur den Tag zu vergleichen.
                today.setHours(0, 0, 0, 0);
                const currentYear = today.getFullYear();
                let nextBirthday = new Date(currentYear, date.getMonth(), date.getDate());
                if (nextBirthday < today) {
                    nextBirthday.setFullYear(currentYear + 1);
                }
                return { timestamp: nextBirthday.getTime() };
            };

            const renderAllTiles = () => {
                countdownData.forEach(item => item.nextBirthdayInfo = getNextBirthdayInfo(item.date));
                countdownData.sort((a, b) => a.nextBirthdayInfo.timestamp - b.nextBirthdayInfo.timestamp);
                grid.innerHTML = '';
                countdownData.forEach(item => {
                    const tileClone = tileTemplate.content.cloneNode(true);
                    const tileElement = tileClone.querySelector('.countdown-tile');
                    tileElement.dataset.id = item.id;
                    tileElement.querySelector('.tile-name').textContent = item.name;
                    tileElement.querySelector('.tile-birthday-text').textContent = item.message;
                    grid.appendChild(tileElement);
                });
                updateAllTimers();
            };

            const updateAllTimers = () => {
                let birthdayIsHappening = false;
                document.querySelectorAll('.countdown-tile').forEach(tile => {
                    const id = parseInt(tile.dataset.id);
                    const item = countdownData.find(d => d.id === id);
                    if (!item || !item.nextBirthdayInfo) return;
                    const now = new Date().getTime();
                    const distance = item.nextBirthdayInfo.timestamp - now;
                    if (isNaN(distance)) return;
                    const oneDayInMs = 24 * 60 * 60 * 1000;
                    if (distance < -oneDayInMs) { renderAllTiles(); return; }
                    if (distance < 0) {
                        tile.classList.add('is-birthday');
                        birthdayIsHappening = true;
                    } else {
                        tile.classList.remove('is-birthday');
                        const days = Math.floor(distance / oneDayInMs);
                        const hours = Math.floor((distance % oneDayInMs) / (1000 * 60 * 60));
                        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                        tile.querySelector('.days').textContent = days;
                        tile.querySelector('.hours').textContent = hours;
                        tile.querySelector('.minutes').textContent = minutes;
                        tile.querySelector('.seconds').textContent = seconds;
                    }
                });
                const newIntensity = birthdayIsHappening ? 400 : 1500;
                if (newIntensity !== fireworksIntensity) { fireworksIntensity = newIntensity; setFireworksInterval(); }
            };

            addButton.addEventListener('click', openAddForm);
            formCancelButton.addEventListener('click', closeForm);
            grid.addEventListener('click', (e) => { const tile = e.target.closest('.countdown-tile'); if (tile) openEditForm(parseInt(tile.dataset.id)); });
            grid.addEventListener('contextmenu', (e) => { e.preventDefault(); const tile = e.target.closest('.countdown-tile'); if (tile) openEditForm(parseInt(tile.dataset.id)); });
            formDeleteButton.addEventListener('click', () => { if (editingTileId && confirm('Diesen Countdown wirklich l√∂schen?')) { countdownData = countdownData.filter(item => item.id !== editingTileId); saveData(); renderAllTiles(); closeForm(); } });
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('form-name').value;
                const date = document.getElementById('form-date').value;
                const message = document.getElementById('form-message').value;
                if (!name || !date || !message) { alert('Bitte alle Felder ausf√ºllen!'); return; }
                if (editingTileId) { const item = countdownData.find(d => d.id === editingTileId); if (item) { item.name = name; item.date = date; item.message = message; } } else { countdownData.push({ id: Date.now(), name, date, message }); }
                saveData(); renderAllTiles(); closeForm();
            });
            loadData();
            renderAllTiles();
            setInterval(updateAllTimers, 1000);
        });
    </script>
</body>
</html>
